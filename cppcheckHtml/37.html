
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Cppcheck - HTML report - [project name]</title>
    <link rel="stylesheet" href="style.css">
    <style>
pre { line-height: 125%; }
td.linenos pre { color: #000000; background-color: #f0f0f0; padding-left: 5px; padding-right: 5px; }
span.linenos { color: #000000; background-color: #f0f0f0; padding-left: 5px; padding-right: 5px; }
td.linenos pre.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.highlight .hll { background-color: #ffffcc }
.highlight { background: #ffffff; }
.highlight .c { color: #888888 } /* Comment */
.highlight .err { color: #FF0000; background-color: #FFAAAA } /* Error */
.highlight .k { color: #008800; font-weight: bold } /* Keyword */
.highlight .o { color: #333333 } /* Operator */
.highlight .ch { color: #888888 } /* Comment.Hashbang */
.highlight .cm { color: #888888 } /* Comment.Multiline */
.highlight .cp { color: #557799 } /* Comment.Preproc */
.highlight .cpf { color: #888888 } /* Comment.PreprocFile */
.highlight .c1 { color: #888888 } /* Comment.Single */
.highlight .cs { color: #cc0000; font-weight: bold } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #c65d09; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0044DD } /* Generic.Traceback */
.highlight .kc { color: #008800; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008800; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008800; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #003388; font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { color: #008800; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #333399; font-weight: bold } /* Keyword.Type */
.highlight .m { color: #6600EE; font-weight: bold } /* Literal.Number */
.highlight .s { background-color: #fff0f0 } /* Literal.String */
.highlight .na { color: #0000CC } /* Name.Attribute */
.highlight .nb { color: #007020 } /* Name.Builtin */
.highlight .nc { color: #BB0066; font-weight: bold } /* Name.Class */
.highlight .no { color: #003366; font-weight: bold } /* Name.Constant */
.highlight .nd { color: #555555; font-weight: bold } /* Name.Decorator */
.highlight .ni { color: #880000; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #FF0000; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0066BB; font-weight: bold } /* Name.Function */
.highlight .nl { color: #997700; font-weight: bold } /* Name.Label */
.highlight .nn { color: #0e84b5; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #007700 } /* Name.Tag */
.highlight .nv { color: #996633 } /* Name.Variable */
.highlight .ow { color: #000000; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mb { color: #6600EE; font-weight: bold } /* Literal.Number.Bin */
.highlight .mf { color: #6600EE; font-weight: bold } /* Literal.Number.Float */
.highlight .mh { color: #005588; font-weight: bold } /* Literal.Number.Hex */
.highlight .mi { color: #0000DD; font-weight: bold } /* Literal.Number.Integer */
.highlight .mo { color: #4400EE; font-weight: bold } /* Literal.Number.Oct */
.highlight .sa { background-color: #fff0f0 } /* Literal.String.Affix */
.highlight .sb { background-color: #fff0f0 } /* Literal.String.Backtick */
.highlight .sc { color: #0044DD } /* Literal.String.Char */
.highlight .dl { background-color: #fff0f0 } /* Literal.String.Delimiter */
.highlight .sd { color: #DD4422 } /* Literal.String.Doc */
.highlight .s2 { background-color: #fff0f0 } /* Literal.String.Double */
.highlight .se { color: #666666; font-weight: bold; background-color: #fff0f0 } /* Literal.String.Escape */
.highlight .sh { background-color: #fff0f0 } /* Literal.String.Heredoc */
.highlight .si { background-color: #eeeeee } /* Literal.String.Interpol */
.highlight .sx { color: #DD2200; background-color: #fff0f0 } /* Literal.String.Other */
.highlight .sr { color: #000000; background-color: #fff0ff } /* Literal.String.Regex */
.highlight .s1 { background-color: #fff0f0 } /* Literal.String.Single */
.highlight .ss { color: #AA6600 } /* Literal.String.Symbol */
.highlight .bp { color: #007020 } /* Name.Builtin.Pseudo */
.highlight .fm { color: #0066BB; font-weight: bold } /* Name.Function.Magic */
.highlight .vc { color: #336699 } /* Name.Variable.Class */
.highlight .vg { color: #dd7700; font-weight: bold } /* Name.Variable.Global */
.highlight .vi { color: #3333BB } /* Name.Variable.Instance */
.highlight .vm { color: #996633 } /* Name.Variable.Magic */
.highlight .il { color: #0000DD; font-weight: bold } /* Literal.Number.Integer.Long */
    </style>
    <script>
      function getStyle(el, styleProp) {
        var y;

        if (el.currentStyle) {
          y = el.currentStyle[styleProp];
        } else if (window.getComputedStyle) {
          y = document.defaultView.getComputedStyle(el, null).getPropertyValue(styleProp);
        }

        return y;
      }

      function toggle() {
        var el = this.expandable_content;
        var mark = this.expandable_marker;

        if (el.style.display === "block") {
          el.style.display = "none";
          mark.textContent = "[+]";
        } else {
          el.style.display = "block";
          mark.textContent = "[-]";
        }
      }

      function initExpandables() {
        var elements = document.querySelectorAll(".expandable");

        for (var i = 0, len = elements.length; i < len; i++) {
          var el = elements[i];
          var clickable = el.querySelector("span");
          var marker = clickable.querySelector(".marker");
          var content = el.querySelector(".content");
          var width = clickable.clientWidth - parseInt(getStyle(content, "padding-left")) - parseInt(getStyle(content, "padding-right"));
          content.style.width = width + "px";
          clickable.expandable_content = content;
          clickable.expandable_marker = marker;
          clickable.addEventListener("click", toggle);
        }
      }

      function toggleDisplay(id) {
        var elements = document.querySelectorAll("." + id);

        for (var i = 0, len = elements.length; i < len; i++) {
          elements[i].classList.toggle("d-none");
        }
      }

      function toggleAll() {
        var elements = document.querySelectorAll("input");

        // starting from 1 since 0 is the "toggle all" input
        for (var i = 1, len = elements.length; i < len; i++) {
          var el = elements[i];

          if (el.checked) {
            el.checked = false;
          } else {
            el.checked = true;
          }

          toggleDisplay(el.id);
        }
      }
      window.addEventListener("load", initExpandables);
    </script>
  </head>
  <body>
    <div id="header" class="header">
      <h1>Cppcheck report - [project name]: ardupilot/modules/ChibiOS/os/hal/ports/AVR/TINY/LLD/TIMv1/hal_st_lld.c</h1>
    </div>
    <div class="wrapper">
      <div id="menu">
       <p id="filename"><a href="index.html">Defects:</a> hal_st_lld.c</p>
<a href="37.html#line-64"> preprocessorErrorDirective 64</a>
    </div>
    <div id="content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254</pre></div></td><td class="code"><div class="highlight"><pre><span></span><a name="line-1"></a><span class="cm">/*</span>
<a name="line-2"></a><span class="cm">    ChibiOS - Copyright (C) 2006..2018 Giovanni Di Sirio</span>
<a name="line-3"></a>
<a name="line-4"></a><span class="cm">    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a name="line-5"></a><span class="cm">    you may not use this file except in compliance with the License.</span>
<a name="line-6"></a><span class="cm">    You may obtain a copy of the License at</span>
<a name="line-7"></a>
<a name="line-8"></a><span class="cm">        http://www.apache.org/licenses/LICENSE-2.0</span>
<a name="line-9"></a>
<a name="line-10"></a><span class="cm">    Unless required by applicable law or agreed to in writing, software</span>
<a name="line-11"></a><span class="cm">    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a name="line-12"></a><span class="cm">    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a name="line-13"></a><span class="cm">    See the License for the specific language governing permissions and</span>
<a name="line-14"></a><span class="cm">    limitations under the License.</span>
<a name="line-15"></a><span class="cm">*/</span>
<a name="line-16"></a>
<a name="line-17"></a><span class="cm">/**</span>
<a name="line-18"></a><span class="cm"> * @file    TIMv1/hal_st_lld.c</span>
<a name="line-19"></a><span class="cm"> * @brief   AVR Tiny ST subsystem low level driver source file.</span>
<a name="line-20"></a><span class="cm"> *</span>
<a name="line-21"></a><span class="cm"> * @addtogroup ST</span>
<a name="line-22"></a><span class="cm"> * @{</span>
<a name="line-23"></a><span class="cm"> */</span>
<a name="line-24"></a>
<a name="line-25"></a><span class="cp">#include</span> <span class="cpf">&quot;hal.h&quot;</span><span class="cp"></span>
<a name="line-26"></a>
<a name="line-27"></a><span class="cp">#if (OSAL_ST_MODE != OSAL_ST_MODE_NONE) || defined(__DOXYGEN__)</span>
<a name="line-28"></a>
<a name="line-29"></a><span class="cm">/*===========================================================================*/</span>
<a name="line-30"></a><span class="cm">/* Driver local definitions.                                                 */</span>
<a name="line-31"></a><span class="cm">/*===========================================================================*/</span>
<a name="line-32"></a>
<a name="line-33"></a><span class="cm">/**</span>
<a name="line-34"></a><span class="cm"> * @brief  Timer maximum value</span>
<a name="line-35"></a><span class="cm"> */</span>
<a name="line-36"></a><span class="cp">#define AVR_TIMER_COUNTER_MAX 255</span>
<a name="line-37"></a>
<a name="line-38"></a><span class="cm">/*===========================================================================*/</span>
<a name="line-39"></a><span class="cm">/* Driver exported variables.                                                */</span>
<a name="line-40"></a><span class="cm">/*===========================================================================*/</span>
<a name="line-41"></a>
<a name="line-42"></a><span class="cm">/*===========================================================================*/</span>
<a name="line-43"></a><span class="cm">/* Driver local types.                                                       */</span>
<a name="line-44"></a><span class="cm">/*===========================================================================*/</span>
<a name="line-45"></a>
<a name="line-46"></a><span class="cm">/*===========================================================================*/</span>
<a name="line-47"></a><span class="cm">/* Driver local variables and types.                                         */</span>
<a name="line-48"></a><span class="cm">/*===========================================================================*/</span>
<a name="line-49"></a>
<a name="line-50"></a><span class="cp">#if (OSAL_ST_MODE == OSAL_ST_MODE_PERIODIC) || defined(__DOXYGEN__)</span>
<a name="line-51"></a>
<a name="line-52"></a><span class="cm">/* Work out what the timer interrupt is called on this MCU */</span>
<a name="line-53"></a><span class="cp">#ifdef TIMER0_COMPA_vect</span>
<a name="line-54"></a>  <span class="cp">#define AVR_TIMER_VECT TIMER0_COMPA_vect</span>
<a name="line-55"></a><span class="cp">#elif defined(TIMER_COMPA_vect)</span>
<a name="line-56"></a>  <span class="cp">#define AVR_TIMER_VECT TIMER_COMPA_vect</span>
<a name="line-57"></a><span class="cp">#elif defined(TIMER0_COMP_vect)</span>
<a name="line-58"></a>  <span class="cp">#define AVR_TIMER_VECT TIMER0_COMP_vect</span>
<a name="line-59"></a><span class="cp">#else</span>
<a name="line-60"></a>  <span class="cp">#error &quot;Cannot find interrupt vector name for timer&quot;</span>
<a name="line-61"></a><span class="cp">#endif</span>
<a name="line-62"></a>
<a name="line-63"></a><span class="cm">/* Find the most suitable prescaler setting for the desired OSAL_ST_FREQUENCY */</span>
<a name="line-64"></a><span class="hll"><span class="cp">#if ((F_CPU / OSAL_ST_FREQUENCY) &lt;= AVR_TIMER_COUNTER_MAX)</span><span class="error2">&lt;--- failed to evaluate #if condition, division/modulo by zero</span>
</span><a name="line-65"></a>
<a name="line-66"></a>  <span class="cp">#define AVR_TIMER_PRESCALER 1</span>
<a name="line-67"></a>  <span class="cp">#define AVR_TIMER_PRESCALER_BITS ((0&lt;&lt;CS02)|(0&lt;&lt;CS01)|(1&lt;&lt;CS00)) </span><span class="cm">/* CLK      */</span><span class="cp"></span>
<a name="line-68"></a>
<a name="line-69"></a><span class="cp">#elif ((F_CPU / OSAL_ST_FREQUENCY / 8) &lt;= AVR_TIMER_COUNTER_MAX)</span>
<a name="line-70"></a>
<a name="line-71"></a>  <span class="cp">#define AVR_TIMER_PRESCALER 8</span>
<a name="line-72"></a>  <span class="cp">#define AVR_TIMER_PRESCALER_BITS ((0&lt;&lt;CS02)|(1&lt;&lt;CS01)|(0&lt;&lt;CS00)) </span><span class="cm">/* CLK/8    */</span><span class="cp"></span>
<a name="line-73"></a>
<a name="line-74"></a><span class="cp">#elif ((F_CPU / OSAL_ST_FREQUENCY / 64) &lt;= AVR_TIMER_COUNTER_MAX)</span>
<a name="line-75"></a>
<a name="line-76"></a>  <span class="cp">#define AVR_TIMER_PRESCALER 64</span>
<a name="line-77"></a>
<a name="line-78"></a>  <span class="cp">#ifdef __AVR_ATmega128__</span>
<a name="line-79"></a>    <span class="cp">#define AVR_TIMER_PRESCALER_BITS ((1&lt;&lt;CS02)|(0&lt;&lt;CS01)|(0&lt;&lt;CS00)) </span><span class="cm">/* CLK/64   */</span><span class="cp"></span>
<a name="line-80"></a>  <span class="cp">#else</span>
<a name="line-81"></a>    <span class="cp">#define AVR_TIMER_PRESCALER_BITS ((0&lt;&lt;CS02)|(1&lt;&lt;CS01)|(1&lt;&lt;CS00)) </span><span class="cm">/* CLK/64   */</span><span class="cp"></span>
<a name="line-82"></a>  <span class="cp">#endif</span>
<a name="line-83"></a>
<a name="line-84"></a><span class="cp">#elif ((F_CPU / OSAL_ST_FREQUENCY / 256) &lt;= AVR_TIMER_COUNTER_MAX)</span>
<a name="line-85"></a>
<a name="line-86"></a>  <span class="cp">#define AVR_TIMER_PRESCALER 256</span>
<a name="line-87"></a>
<a name="line-88"></a>  <span class="cp">#ifdef __AVR_ATmega128__</span>
<a name="line-89"></a>    <span class="cp">#define AVR_TIMER_PRESCALER_BITS ((1&lt;&lt;CS02)|(1&lt;&lt;CS01)|(0&lt;&lt;CS00)) </span><span class="cm">/* CLK/256  */</span><span class="cp"></span>
<a name="line-90"></a>  <span class="cp">#else</span>
<a name="line-91"></a>    <span class="cp">#define AVR_TIMER_PRESCALER_BITS ((1&lt;&lt;CS02)|(0&lt;&lt;CS01)|(0&lt;&lt;CS00)) </span><span class="cm">/* CLK/256  */</span><span class="cp"></span>
<a name="line-92"></a>  <span class="cp">#endif</span>
<a name="line-93"></a>
<a name="line-94"></a><span class="cp">#elif ((F_CPU / OSAL_ST_FREQUENCY / 1024) &lt;= AVR_TIMER_COUNTER_MAX)</span>
<a name="line-95"></a>
<a name="line-96"></a>  <span class="cp">#define AVR_TIMER_PRESCALER 1024</span>
<a name="line-97"></a>
<a name="line-98"></a>  <span class="cp">#ifdef __AVR_ATmega128__</span>
<a name="line-99"></a>    <span class="cp">#define AVR_TIMER_PRESCALER_BITS (1&lt;&lt;CS02)|(1&lt;&lt;CS01)|(1&lt;&lt;CS00); </span><span class="cm">/* CLK/1024 */</span><span class="cp"></span>
<a name="line-100"></a>  <span class="cp">#else</span>
<a name="line-101"></a>    <span class="cp">#define AVR_TIMER_PRESCALER_BITS (1&lt;&lt;CS02)|(0&lt;&lt;CS01)|(1&lt;&lt;CS00); </span><span class="cm">/* CLK/1024 */</span><span class="cp"></span>
<a name="line-102"></a>  <span class="cp">#endif</span>
<a name="line-103"></a>
<a name="line-104"></a><span class="cp">#else</span>
<a name="line-105"></a>  <span class="cp">#error &quot;Frequency too low for timer, please set OSAL_ST_FREQUENCY to a higher value&quot;</span>
<a name="line-106"></a><span class="cp">#endif</span>
<a name="line-107"></a>
<a name="line-108"></a><span class="cp">#define AVR_TIMER_COUNTER (F_CPU / OSAL_ST_FREQUENCY / AVR_TIMER_PRESCALER)</span>
<a name="line-109"></a>
<a name="line-110"></a><span class="cm">/* Test if OSAL_ST_FREQUENCY can be matched exactly using this timer */</span>
<a name="line-111"></a><span class="cp">#define F_CPU_ (AVR_TIMER_COUNTER * AVR_TIMER_PRESCALER * OSAL_ST_FREQUENCY)</span>
<a name="line-112"></a><span class="cp">#if (F_CPU_ != F_CPU)</span>
<a name="line-113"></a>  <span class="cp">#warning &quot;OSAL_ST_FREQUENCY cannot be generated exactly using timer&quot;</span>
<a name="line-114"></a><span class="cp">#endif</span>
<a name="line-115"></a><span class="cp">#undef F_CPU_</span>
<a name="line-116"></a>
<a name="line-117"></a><span class="cp">#endif </span><span class="cm">/* OSAL_ST_MODE == OSAL_ST_MODE_PERIODIC */</span><span class="cp"></span>
<a name="line-118"></a>
<a name="line-119"></a><span class="cp">#if (OSAL_ST_MODE == OSAL_ST_MODE_FREERUNNING) || defined(__DOXYGEN__)</span>
<a name="line-120"></a>
<a name="line-121"></a><span class="cm">/* FIXME: Prescaler is now fixed in 1024.</span>
<a name="line-122"></a><span class="cm"> *        Should add support for calculating best value according to</span>
<a name="line-123"></a><span class="cm"> *        user requested configuration.</span>
<a name="line-124"></a><span class="cm"> */</span>
<a name="line-125"></a><span class="cp">#define PRESCALER (_BV(CS12) | _BV(CS10))</span>
<a name="line-126"></a>
<a name="line-127"></a><span class="cp">#endif </span><span class="cm">/* OSAL_ST_MODE == OSAL_ST_MODE_FREERUNNING */</span><span class="cp"></span>
<a name="line-128"></a>
<a name="line-129"></a><span class="cm">/*===========================================================================*/</span>
<a name="line-130"></a><span class="cm">/* Driver local functions.                                                   */</span>
<a name="line-131"></a><span class="cm">/*===========================================================================*/</span>
<a name="line-132"></a>
<a name="line-133"></a><span class="cm">/*===========================================================================*/</span>
<a name="line-134"></a><span class="cm">/* Driver interrupt handlers.                                                */</span>
<a name="line-135"></a><span class="cm">/*===========================================================================*/</span>
<a name="line-136"></a>
<a name="line-137"></a><span class="cp">#if (OSAL_ST_MODE == OSAL_ST_MODE_PERIODIC) || defined(__DOXYGEN__)</span>
<a name="line-138"></a>
<a name="line-139"></a><span class="cm">/**</span>
<a name="line-140"></a><span class="cm"> * @brief Timer handler for periodic mode.</span>
<a name="line-141"></a><span class="cm"> */</span>
<a name="line-142"></a><span class="n">OSAL_IRQ_HANDLER</span><span class="p">(</span><span class="n">AVR_TIMER_VECT</span><span class="p">)</span> <span class="p">{</span>
<a name="line-143"></a>
<a name="line-144"></a>  <span class="n">OSAL_IRQ_PROLOGUE</span><span class="p">();</span>
<a name="line-145"></a>
<a name="line-146"></a>  <span class="n">osalSysLockFromISR</span><span class="p">();</span>
<a name="line-147"></a>  <span class="n">osalOsTimerHandlerI</span><span class="p">();</span>
<a name="line-148"></a>  <span class="n">osalSysUnlockFromISR</span><span class="p">();</span>
<a name="line-149"></a>
<a name="line-150"></a>  <span class="n">OSAL_IRQ_EPILOGUE</span><span class="p">();</span>
<a name="line-151"></a><span class="p">}</span>
<a name="line-152"></a>
<a name="line-153"></a><span class="cp">#endif </span><span class="cm">/* OSAL_ST_MODE == OSAL_ST_MODE_PERIODIC */</span><span class="cp"></span>
<a name="line-154"></a>
<a name="line-155"></a><span class="cp">#if (OSAL_ST_MODE == OSAL_ST_MODE_FREERUNNING) || defined(__DOXYGEN__)</span>
<a name="line-156"></a>
<a name="line-157"></a><span class="cm">/**</span>
<a name="line-158"></a><span class="cm"> * @brief Timer handler for free running mode.</span>
<a name="line-159"></a><span class="cm"> */</span>
<a name="line-160"></a><span class="n">OSAL_IRQ_HANDLER</span><span class="p">(</span><span class="n">TIMER1_COMPA_vect</span><span class="p">)</span> <span class="p">{</span>
<a name="line-161"></a>
<a name="line-162"></a>  <span class="n">OSAL_IRQ_PROLOGUE</span><span class="p">();</span>
<a name="line-163"></a>
<a name="line-164"></a>  <span class="cm">/* TODO: reset status if required. */</span>
<a name="line-165"></a>
<a name="line-166"></a>  <span class="n">osalSysLockFromISR</span><span class="p">();</span>
<a name="line-167"></a>  <span class="n">osalOsTimerHandlerI</span><span class="p">();</span>
<a name="line-168"></a>  <span class="n">osalSysUnlockFromISR</span><span class="p">();</span>
<a name="line-169"></a>
<a name="line-170"></a>  <span class="n">OSAL_IRQ_EPILOGUE</span><span class="p">();</span>
<a name="line-171"></a><span class="p">}</span>
<a name="line-172"></a>
<a name="line-173"></a><span class="cp">#endif </span><span class="cm">/* OSAL_ST_MODE == OSAL_ST_MODE_FREERUNNING */</span><span class="cp"></span>
<a name="line-174"></a>
<a name="line-175"></a><span class="cm">/*===========================================================================*/</span>
<a name="line-176"></a><span class="cm">/* Driver exported functions.                                                */</span>
<a name="line-177"></a><span class="cm">/*===========================================================================*/</span>
<a name="line-178"></a>
<a name="line-179"></a><span class="cm">/**</span>
<a name="line-180"></a><span class="cm"> * @brief   Low level ST driver initialization.</span>
<a name="line-181"></a><span class="cm"> *</span>
<a name="line-182"></a><span class="cm"> * @notapi</span>
<a name="line-183"></a><span class="cm"> */</span>
<a name="line-184"></a><span class="kt">void</span> <span class="n">st_lld_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
<a name="line-185"></a>
<a name="line-186"></a><span class="cp">#if (OSAL_ST_MODE == OSAL_ST_MODE_FREERUNNING) || defined(__DOXYGEN__)</span>
<a name="line-187"></a>
<a name="line-188"></a>  <span class="cm">/*</span>
<a name="line-189"></a><span class="cm">   * Periodic mode uses Timer 1 (16 bit).</span>
<a name="line-190"></a><span class="cm">   */</span>
<a name="line-191"></a>
<a name="line-192"></a>  <span class="cm">/* CTC mode, no clock source. */</span>
<a name="line-193"></a>  <span class="n">TCCR1A</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-194"></a>  <span class="n">TCCR1B</span>     <span class="o">=</span> <span class="n">_BV</span><span class="p">(</span><span class="n">WGM12</span><span class="p">);</span>
<a name="line-195"></a>
<a name="line-196"></a>  <span class="cm">/* Start disabled. */</span>
<a name="line-197"></a>  <span class="n">TCCR1C</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-198"></a>  <span class="n">OCR1A</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-199"></a>  <span class="n">TCNT1</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-200"></a>  <span class="n">TIFR_REG</span>   <span class="o">=</span> <span class="n">_BV</span><span class="p">(</span><span class="n">OCF1A</span><span class="p">);</span>                              <span class="cm">/* Reset pending.   */</span>
<a name="line-201"></a>  <span class="n">TIMSK_REG</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-202"></a>  <span class="n">TCCR1B</span>     <span class="o">=</span> <span class="n">PRESCALER</span><span class="p">;</span>
<a name="line-203"></a>
<a name="line-204"></a><span class="cp">#endif </span><span class="cm">/* OSAL_ST_MODE == OSAL_ST_MODE_FREERUNNING */</span><span class="cp"></span>
<a name="line-205"></a>
<a name="line-206"></a><span class="cp">#if (OSAL_ST_MODE == OSAL_ST_MODE_PERIODIC) || defined(__DOXYGEN__)</span>
<a name="line-207"></a>
<a name="line-208"></a>  <span class="cm">/*</span>
<a name="line-209"></a><span class="cm">   * Periodic mode uses Timer 0 (8 bit).</span>
<a name="line-210"></a><span class="cm">   */</span>
<a name="line-211"></a><span class="cp">#if defined(TCCR0B) </span><span class="cm">/* Timer has multiple output comparators.               */</span><span class="cp"></span>
<a name="line-212"></a>  <span class="n">TCCR0A</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WGM01</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">WGM00</span><span class="p">)</span> <span class="o">|</span>               <span class="cm">/* CTC mode.        */</span>
<a name="line-213"></a>            <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">COM0A1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">COM0A0</span><span class="p">);</span>              <span class="cm">/* OC0A disabled.   */</span>
<a name="line-214"></a>            <span class="c1">//(0 &lt;&lt; COM0B1) | (0 &lt;&lt; COM0B0);            /* OC0B disabled.   */</span>
<a name="line-215"></a>  <span class="cm">/* FIXME: See if the line bellow must be delate or recoded.               */</span>
<a name="line-216"></a>  <span class="c1">//TCCR0B  = (0 &lt;&lt; WGM02) | AVR_TIMER_PRESCALER_BITS;  /* CTC mode.        */</span>
<a name="line-217"></a>  <span class="n">OCR0A</span>   <span class="o">=</span> <span class="n">AVR_TIMER_COUNTER</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<a name="line-218"></a>  <span class="n">TCNT0</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                                          <span class="cm">/* Reset counter.   */</span>
<a name="line-219"></a><span class="cp">#if defined(__AVR_ATtiny85__)</span>
<a name="line-220"></a>  <span class="n">TIFR</span>    <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OCF0A</span><span class="p">);</span>                               <span class="cm">/* Reset pending.   */</span>
<a name="line-221"></a>  <span class="n">TIMSK</span>   <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OCIE0A</span><span class="p">);</span>                              <span class="cm">/* IRQ on compare.  */</span>
<a name="line-222"></a><span class="cp">#else</span>
<a name="line-223"></a>  <span class="n">TIFR0</span>   <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OCF0A</span><span class="p">);</span>                               <span class="cm">/* Reset pending.   */</span>
<a name="line-224"></a>  <span class="n">TIMSK0</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OCIE0A</span><span class="p">);</span>                              <span class="cm">/* IRQ on compare.  */</span>
<a name="line-225"></a><span class="cp">#endif</span>
<a name="line-226"></a>
<a name="line-227"></a><span class="cp">#elif defined(TCCR0A) </span><span class="cm">/* AT90CAN doesn&#39;t have TCCR0B and slightly different */</span><span class="cp"></span>
<a name="line-228"></a>                      <span class="cm">/* TCCR0A.                                            */</span>
<a name="line-229"></a>  <span class="n">TCCR0A</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WGM01</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">WGM00</span><span class="p">)</span> <span class="o">|</span>               <span class="cm">/* CTC mode.        */</span>
<a name="line-230"></a>            <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">COM0A1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">COM0A0</span><span class="p">);</span>              <span class="cm">/* OC0A disabled.   */</span>
<a name="line-231"></a>  <span class="n">OCR0A</span>   <span class="o">=</span> <span class="n">AVR_TIMER_COUNTER</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<a name="line-232"></a>  <span class="n">TCNT0</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                                          <span class="cm">/* Reset counter.   */</span>
<a name="line-233"></a>  <span class="n">TIFR0</span>   <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OCF0A</span><span class="p">);</span>                               <span class="cm">/* Reset pending.   */</span>
<a name="line-234"></a>  <span class="n">TIMSK0</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OCIE0A</span><span class="p">);</span>                              <span class="cm">/* IRQ on compare.  */</span>
<a name="line-235"></a>
<a name="line-236"></a><span class="cp">#elif defined(TCCR0) </span><span class="cm">/* Timer has single output comparator                  */</span><span class="cp"></span>
<a name="line-237"></a>  <span class="n">TCCR0</span>   <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WGM01</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">WGM00</span><span class="p">)</span> <span class="o">|</span>               <span class="cm">/* CTC mode.        */</span>
<a name="line-238"></a>            <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">COM01</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">COM00</span><span class="p">)</span> <span class="o">|</span>               <span class="cm">/* OC0A disabled.   */</span>
<a name="line-239"></a>            <span class="n">AVR_TIMER_PRESCALER_BITS</span><span class="p">;</span>
<a name="line-240"></a>  <span class="n">OCR0</span>    <span class="o">=</span> <span class="n">AVR_TIMER_COUNTER</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<a name="line-241"></a>  <span class="n">TCNT0</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                                          <span class="cm">/* Reset counter.   */</span>
<a name="line-242"></a>  <span class="n">TIFR</span>    <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OCF0</span><span class="p">);</span>                                <span class="cm">/* Reset pending.   */</span>
<a name="line-243"></a>  <span class="n">TIMSK</span>   <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OCIE0</span><span class="p">);</span>                               <span class="cm">/* IRQ on compare.  */</span>
<a name="line-244"></a><span class="cp">#else</span>
<a name="line-245"></a>  <span class="cp">#error &quot;Neither TCCR0A nor TCCR0 registers are defined&quot;</span>
<a name="line-246"></a><span class="cp">#endif</span>
<a name="line-247"></a>
<a name="line-248"></a><span class="cp">#endif </span><span class="cm">/* OSAL_ST_MODE == OSAL_ST_MODE_PERIODIC */</span><span class="cp"></span>
<a name="line-249"></a>
<a name="line-250"></a><span class="p">}</span>
<a name="line-251"></a>
<a name="line-252"></a><span class="cp">#endif </span><span class="cm">/* OSAL_ST_MODE != OSAL_ST_MODE_NONE */</span><span class="cp"></span>
<a name="line-253"></a>
<a name="line-254"></a><span class="cm">/** @} */</span>
</pre></div>
</td></tr></table>
      </div> <!-- /.wrapper -->
    </div>
    <div id="footer" class="footer">
      <p>
        Cppcheck 2.3 - a tool for static C/C++ code analysis<br>
        <br>
        Internet: <a href="http://cppcheck.net">http://cppcheck.net</a><br>
        IRC: <a href="irc://irc.freenode.net/cppcheck">irc://irc.freenode.net/cppcheck</a><br>
      </p>
    </div>
  </body>
</html>
