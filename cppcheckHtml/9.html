
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Cppcheck - HTML report - [project name]</title>
    <link rel="stylesheet" href="style.css">
    <style>
pre { line-height: 125%; }
td.linenos pre { color: #000000; background-color: #f0f0f0; padding-left: 5px; padding-right: 5px; }
span.linenos { color: #000000; background-color: #f0f0f0; padding-left: 5px; padding-right: 5px; }
td.linenos pre.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.highlight .hll { background-color: #ffffcc }
.highlight { background: #ffffff; }
.highlight .c { color: #888888 } /* Comment */
.highlight .err { color: #FF0000; background-color: #FFAAAA } /* Error */
.highlight .k { color: #008800; font-weight: bold } /* Keyword */
.highlight .o { color: #333333 } /* Operator */
.highlight .ch { color: #888888 } /* Comment.Hashbang */
.highlight .cm { color: #888888 } /* Comment.Multiline */
.highlight .cp { color: #557799 } /* Comment.Preproc */
.highlight .cpf { color: #888888 } /* Comment.PreprocFile */
.highlight .c1 { color: #888888 } /* Comment.Single */
.highlight .cs { color: #cc0000; font-weight: bold } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #c65d09; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0044DD } /* Generic.Traceback */
.highlight .kc { color: #008800; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008800; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008800; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #003388; font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { color: #008800; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #333399; font-weight: bold } /* Keyword.Type */
.highlight .m { color: #6600EE; font-weight: bold } /* Literal.Number */
.highlight .s { background-color: #fff0f0 } /* Literal.String */
.highlight .na { color: #0000CC } /* Name.Attribute */
.highlight .nb { color: #007020 } /* Name.Builtin */
.highlight .nc { color: #BB0066; font-weight: bold } /* Name.Class */
.highlight .no { color: #003366; font-weight: bold } /* Name.Constant */
.highlight .nd { color: #555555; font-weight: bold } /* Name.Decorator */
.highlight .ni { color: #880000; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #FF0000; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0066BB; font-weight: bold } /* Name.Function */
.highlight .nl { color: #997700; font-weight: bold } /* Name.Label */
.highlight .nn { color: #0e84b5; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #007700 } /* Name.Tag */
.highlight .nv { color: #996633 } /* Name.Variable */
.highlight .ow { color: #000000; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mb { color: #6600EE; font-weight: bold } /* Literal.Number.Bin */
.highlight .mf { color: #6600EE; font-weight: bold } /* Literal.Number.Float */
.highlight .mh { color: #005588; font-weight: bold } /* Literal.Number.Hex */
.highlight .mi { color: #0000DD; font-weight: bold } /* Literal.Number.Integer */
.highlight .mo { color: #4400EE; font-weight: bold } /* Literal.Number.Oct */
.highlight .sa { background-color: #fff0f0 } /* Literal.String.Affix */
.highlight .sb { background-color: #fff0f0 } /* Literal.String.Backtick */
.highlight .sc { color: #0044DD } /* Literal.String.Char */
.highlight .dl { background-color: #fff0f0 } /* Literal.String.Delimiter */
.highlight .sd { color: #DD4422 } /* Literal.String.Doc */
.highlight .s2 { background-color: #fff0f0 } /* Literal.String.Double */
.highlight .se { color: #666666; font-weight: bold; background-color: #fff0f0 } /* Literal.String.Escape */
.highlight .sh { background-color: #fff0f0 } /* Literal.String.Heredoc */
.highlight .si { background-color: #eeeeee } /* Literal.String.Interpol */
.highlight .sx { color: #DD2200; background-color: #fff0f0 } /* Literal.String.Other */
.highlight .sr { color: #000000; background-color: #fff0ff } /* Literal.String.Regex */
.highlight .s1 { background-color: #fff0f0 } /* Literal.String.Single */
.highlight .ss { color: #AA6600 } /* Literal.String.Symbol */
.highlight .bp { color: #007020 } /* Name.Builtin.Pseudo */
.highlight .fm { color: #0066BB; font-weight: bold } /* Name.Function.Magic */
.highlight .vc { color: #336699 } /* Name.Variable.Class */
.highlight .vg { color: #dd7700; font-weight: bold } /* Name.Variable.Global */
.highlight .vi { color: #3333BB } /* Name.Variable.Instance */
.highlight .vm { color: #996633 } /* Name.Variable.Magic */
.highlight .il { color: #0000DD; font-weight: bold } /* Literal.Number.Integer.Long */
    </style>
    <script>
      function getStyle(el, styleProp) {
        var y;

        if (el.currentStyle) {
          y = el.currentStyle[styleProp];
        } else if (window.getComputedStyle) {
          y = document.defaultView.getComputedStyle(el, null).getPropertyValue(styleProp);
        }

        return y;
      }

      function toggle() {
        var el = this.expandable_content;
        var mark = this.expandable_marker;

        if (el.style.display === "block") {
          el.style.display = "none";
          mark.textContent = "[+]";
        } else {
          el.style.display = "block";
          mark.textContent = "[-]";
        }
      }

      function initExpandables() {
        var elements = document.querySelectorAll(".expandable");

        for (var i = 0, len = elements.length; i < len; i++) {
          var el = elements[i];
          var clickable = el.querySelector("span");
          var marker = clickable.querySelector(".marker");
          var content = el.querySelector(".content");
          var width = clickable.clientWidth - parseInt(getStyle(content, "padding-left")) - parseInt(getStyle(content, "padding-right"));
          content.style.width = width + "px";
          clickable.expandable_content = content;
          clickable.expandable_marker = marker;
          clickable.addEventListener("click", toggle);
        }
      }

      function toggleDisplay(id) {
        var elements = document.querySelectorAll("." + id);

        for (var i = 0, len = elements.length; i < len; i++) {
          elements[i].classList.toggle("d-none");
        }
      }

      function toggleAll() {
        var elements = document.querySelectorAll("input");

        // starting from 1 since 0 is the "toggle all" input
        for (var i = 1, len = elements.length; i < len; i++) {
          var el = elements[i];

          if (el.checked) {
            el.checked = false;
          } else {
            el.checked = true;
          }

          toggleDisplay(el.id);
        }
      }
      window.addEventListener("load", initExpandables);
    </script>
  </head>
  <body>
    <div id="header" class="header">
      <h1>Cppcheck report - [project name]: ardupilot/libraries/AP_HAL/utility/ftoa_engine.cpp</h1>
    </div>
    <div class="wrapper">
      <div id="menu">
       <p id="filename"><a href="index.html">Defects:</a> ftoa_engine.cpp</p>
<a href="9.html#line-93"> objectIndex 93</a><a href="9.html#line-93"> objectIndex 93</a><a href="9.html#line-93"> objectIndex 93</a><a href="9.html#line-104"> objectIndex 104</a><a href="9.html#line-105"> objectIndex 105</a><a href="9.html#line-106"> objectIndex 106</a>
    </div>
    <div id="content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229</pre></div></td><td class="code"><div class="highlight"><pre><span></span><a name="line-1"></a><span class="cm">/* Copyright (c) 2005, Dmitry Xmelkov</span>
<a name="line-2"></a><span class="cm">   All rights reserved.</span>
<a name="line-3"></a>
<a name="line-4"></a><span class="cm">   Rewritten in C by Soren Kuula</span>
<a name="line-5"></a>
<a name="line-6"></a><span class="cm">   Redistribution and use in source and binary forms, with or without</span>
<a name="line-7"></a><span class="cm">   modification, are permitted provided that the following conditions are met:</span>
<a name="line-8"></a>
<a name="line-9"></a><span class="cm">   * Redistributions of source code must retain the above copyright</span>
<a name="line-10"></a><span class="cm">     notice, this list of conditions and the following disclaimer.</span>
<a name="line-11"></a><span class="cm">   * Redistributions in binary form must reproduce the above copyright</span>
<a name="line-12"></a><span class="cm">     notice, this list of conditions and the following disclaimer in</span>
<a name="line-13"></a><span class="cm">     the documentation and/or other materials provided with the</span>
<a name="line-14"></a><span class="cm">     distribution.</span>
<a name="line-15"></a><span class="cm">   * Neither the name of the copyright holders nor the names of</span>
<a name="line-16"></a><span class="cm">     contributors may be used to endorse or promote products derived</span>
<a name="line-17"></a><span class="cm">     from this software without specific prior written permission.</span>
<a name="line-18"></a>
<a name="line-19"></a><span class="cm">  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span>
<a name="line-20"></a><span class="cm">  AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<a name="line-21"></a><span class="cm">  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<a name="line-22"></a><span class="cm">  ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE</span>
<a name="line-23"></a><span class="cm">  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<a name="line-24"></a><span class="cm">  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<a name="line-25"></a><span class="cm">  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
<a name="line-26"></a><span class="cm">  INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
<a name="line-27"></a><span class="cm">  CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
<a name="line-28"></a><span class="cm">  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<a name="line-29"></a><span class="cm">  POSSIBILITY OF SUCH DAMAGE. */</span>
<a name="line-30"></a>
<a name="line-31"></a><span class="cp">#include</span> <span class="cpf">&quot;ftoa_engine.h&quot;</span><span class="cp"></span>
<a name="line-32"></a>
<a name="line-33"></a><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp"></span>
<a name="line-34"></a>
<a name="line-35"></a><span class="cp">#include</span> <span class="cpf">&lt;AP_Common/AP_Common.h&gt;</span><span class="cp"></span>
<a name="line-36"></a><span class="cp">#include</span> <span class="cpf">&lt;AP_HAL/AP_HAL.h&gt;</span><span class="cp"></span>
<a name="line-37"></a>
<a name="line-38"></a><span class="cm">/*</span>
<a name="line-39"></a><span class="cm"> * 2^b ~= f * r * 10^e</span>
<a name="line-40"></a><span class="cm"> * where</span>
<a name="line-41"></a><span class="cm"> * i = b div 8</span>
<a name="line-42"></a><span class="cm"> * r = 2^(b mod 8)</span>
<a name="line-43"></a><span class="cm"> * f = factorTable[i]</span>
<a name="line-44"></a><span class="cm"> * e = exponentTable[i]</span>
<a name="line-45"></a><span class="cm"> */</span>
<a name="line-46"></a><span class="k">static</span> <span class="k">const</span> <span class="kt">int8_t</span> <span class="n">exponentTable</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a name="line-47"></a>    <span class="mi">-36</span><span class="p">,</span> <span class="mi">-33</span><span class="p">,</span> <span class="mi">-31</span><span class="p">,</span> <span class="mi">-29</span><span class="p">,</span> <span class="mi">-26</span><span class="p">,</span> <span class="mi">-24</span><span class="p">,</span> <span class="mi">-21</span><span class="p">,</span> <span class="mi">-19</span><span class="p">,</span>
<a name="line-48"></a>    <span class="mi">-17</span><span class="p">,</span> <span class="mi">-14</span><span class="p">,</span> <span class="mi">-12</span><span class="p">,</span> <span class="mi">-9</span><span class="p">,</span>  <span class="mi">-7</span><span class="p">,</span> <span class="mi">-4</span><span class="p">,</span> <span class="mi">-2</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>
<a name="line-49"></a>    <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>  <span class="mi">17</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span>
<a name="line-50"></a>    <span class="mi">22</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span>  <span class="mi">32</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">39</span>
<a name="line-51"></a><span class="p">};</span>
<a name="line-52"></a>
<a name="line-53"></a><span class="k">static</span> <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">factorTable</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a name="line-54"></a>    <span class="mi">2295887404UL</span><span class="p">,</span>
<a name="line-55"></a>    <span class="mi">587747175UL</span><span class="p">,</span>
<a name="line-56"></a>    <span class="mi">1504632769UL</span><span class="p">,</span>
<a name="line-57"></a>    <span class="mi">3851859889UL</span><span class="p">,</span>
<a name="line-58"></a>    <span class="mi">986076132UL</span><span class="p">,</span>
<a name="line-59"></a>    <span class="mi">2524354897UL</span><span class="p">,</span>
<a name="line-60"></a>    <span class="mi">646234854UL</span><span class="p">,</span>
<a name="line-61"></a>    <span class="mi">1654361225UL</span><span class="p">,</span>
<a name="line-62"></a>    <span class="mi">4235164736UL</span><span class="p">,</span>
<a name="line-63"></a>    <span class="mi">1084202172UL</span><span class="p">,</span>
<a name="line-64"></a>    <span class="mi">2775557562UL</span><span class="p">,</span>
<a name="line-65"></a>    <span class="mi">710542736UL</span><span class="p">,</span>
<a name="line-66"></a>    <span class="mi">1818989404UL</span><span class="p">,</span>
<a name="line-67"></a>    <span class="mi">465661287UL</span><span class="p">,</span>
<a name="line-68"></a>    <span class="mi">1192092896UL</span><span class="p">,</span>
<a name="line-69"></a>    <span class="mi">3051757813UL</span><span class="p">,</span>
<a name="line-70"></a>    <span class="mi">781250000UL</span><span class="p">,</span>
<a name="line-71"></a>    <span class="mi">2000000000UL</span><span class="p">,</span>
<a name="line-72"></a>    <span class="mi">512000000UL</span><span class="p">,</span>
<a name="line-73"></a>    <span class="mi">1310720000UL</span><span class="p">,</span>
<a name="line-74"></a>    <span class="mi">3355443200UL</span><span class="p">,</span>
<a name="line-75"></a>    <span class="mi">858993459UL</span><span class="p">,</span>
<a name="line-76"></a>    <span class="mi">2199023256UL</span><span class="p">,</span>
<a name="line-77"></a>    <span class="mi">562949953UL</span><span class="p">,</span>
<a name="line-78"></a>    <span class="mi">1441151881UL</span><span class="p">,</span>
<a name="line-79"></a>    <span class="mi">3689348815UL</span><span class="p">,</span>
<a name="line-80"></a>    <span class="mi">944473297UL</span><span class="p">,</span>
<a name="line-81"></a>    <span class="mi">2417851639UL</span><span class="p">,</span>
<a name="line-82"></a>    <span class="mi">618970020UL</span><span class="p">,</span>
<a name="line-83"></a>    <span class="mi">1584563250UL</span><span class="p">,</span>
<a name="line-84"></a>    <span class="mi">4056481921UL</span><span class="p">,</span>
<a name="line-85"></a>    <span class="mi">1038459372UL</span>
<a name="line-86"></a><span class="p">};</span>
<a name="line-87"></a>
<a name="line-88"></a><span class="kt">int16_t</span> <span class="nf">ftoa_engine</span><span class="p">(</span><span class="kt">float</span> <span class="n">val</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">precision</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">maxDecimals</span><span class="p">)</span> 
<a name="line-89"></a><span class="p">{</span>
<a name="line-90"></a>    <span class="kt">uint8_t</span> <span class="n">flags</span><span class="p">;</span>
<a name="line-91"></a>
<a name="line-92"></a>    <span class="c1">// Bit reinterpretation hacks. This will ONLY work on little endian machines.</span>
<a name="line-93"></a><span class="hll">    <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">valbits</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">val</span><span class="p">;</span><span class="error2">&lt;--- Address of variable taken here.</span><span class="error2">&lt;--- Address of variable taken here.</span><span class="error2">&lt;--- Address of variable taken here.</span>
</span><a name="line-94"></a>    <span class="k">union</span> <span class="p">{</span>
<a name="line-95"></a>        <span class="kt">float</span> <span class="n">v</span><span class="p">;</span>
<a name="line-96"></a>        <span class="kt">uint32_t</span> <span class="n">u</span><span class="p">;</span>
<a name="line-97"></a>    <span class="p">}</span> <span class="n">x</span><span class="p">;</span>
<a name="line-98"></a>    <span class="n">x</span><span class="p">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<a name="line-99"></a>    <span class="kt">uint32_t</span> <span class="n">frac</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">u</span> <span class="o">&amp;</span> <span class="mh">0x007fffffUL</span><span class="p">;</span>
<a name="line-100"></a>
<a name="line-101"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">precision</span><span class="o">&gt;</span><span class="mi">7</span><span class="p">)</span> <span class="n">precision</span><span class="o">=</span><span class="mi">7</span><span class="p">;</span>
<a name="line-102"></a>
<a name="line-103"></a>    <span class="c1">// Read the sign, shift the exponent in place and delete it from frac.</span>
<a name="line-104"></a><span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="n">valbits</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">))</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">FTOA_MINUS</span><span class="p">;</span> <span class="k">else</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="error2">&lt;--- The address of local variable 'val' is accessed at non-zero index.</span>
</span><a name="line-105"></a><span class="hll">    <span class="kt">uint8_t</span> <span class="n">exp</span> <span class="o">=</span> <span class="n">valbits</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">;</span><span class="error2">&lt;--- The address of local variable 'val' is accessed at non-zero index.</span>
</span><a name="line-106"></a><span class="hll">    <span class="k">if</span><span class="p">(</span><span class="n">valbits</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">))</span> <span class="n">exp</span><span class="o">++</span><span class="p">;</span>    <span class="c1">// TODO possible but in case of subnormal</span><span class="error2">&lt;--- The address of local variable 'val' is accessed at non-zero index.</span>
</span><a name="line-107"></a>
<a name="line-108"></a>    <span class="c1">// Test for easy cases, zero and NaN</span>
<a name="line-109"></a>    <span class="k">if</span><span class="p">(</span><span class="n">exp</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">frac</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="line-110"></a>        <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">|</span> <span class="n">FTOA_ZERO</span><span class="p">;</span>
<a name="line-111"></a>        <span class="kt">uint8_t</span> <span class="n">i</span><span class="p">;</span>
<a name="line-112"></a>        <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;=</span><span class="n">precision</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<a name="line-113"></a>            <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
<a name="line-114"></a>        <span class="p">}</span>
<a name="line-115"></a>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-116"></a>    <span class="p">}</span>
<a name="line-117"></a>
<a name="line-118"></a>    <span class="k">if</span><span class="p">(</span><span class="n">exp</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
<a name="line-119"></a>        <span class="k">if</span><span class="p">(</span><span class="n">frac</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">flags</span> <span class="o">|=</span> <span class="n">FTOA_INF</span><span class="p">;</span> <span class="k">else</span> <span class="n">flags</span> <span class="o">|=</span> <span class="n">FTOA_NAN</span><span class="p">;</span>
<a name="line-120"></a>    <span class="p">}</span>
<a name="line-121"></a>
<a name="line-122"></a>    <span class="c1">// The implicit leading 1 is made explicit, except if value subnormal.</span>
<a name="line-123"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">exp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">frac</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1UL</span><span class="o">&lt;&lt;</span><span class="mi">23</span><span class="p">);</span>
<a name="line-124"></a>
<a name="line-125"></a>    <span class="kt">uint8_t</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">exp</span><span class="o">&gt;&gt;</span><span class="mi">3</span><span class="p">;</span>
<a name="line-126"></a>    <span class="kt">int8_t</span> <span class="n">exp10</span> <span class="o">=</span> <span class="n">exponentTable</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
<a name="line-127"></a>
<a name="line-128"></a>    <span class="c1">// We COULD try making the multiplication in situ, where we make</span>
<a name="line-129"></a>    <span class="c1">// frac and a 64 bit int overlap in memory and select/weigh the</span>
<a name="line-130"></a>    <span class="c1">// upper 32 bits that way. For starters, this is less risky:</span>
<a name="line-131"></a>    <span class="kt">int64_t</span> <span class="n">prod</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int64_t</span><span class="p">)</span><span class="n">frac</span> <span class="o">*</span> <span class="p">(</span><span class="kt">int64_t</span><span class="p">)</span><span class="n">factorTable</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
<a name="line-132"></a>
<a name="line-133"></a>    <span class="c1">// The expConvFactorTable are factor are correct iff the lower 3 exponent</span>
<a name="line-134"></a>    <span class="c1">// bits are 1 (=7). Else we need to compensate by divding frac.</span>
<a name="line-135"></a>    <span class="c1">// If the lower 3 bits are 7 we are right.</span>
<a name="line-136"></a>    <span class="c1">// If the lower 3 bits are 6 we right-shift once</span>
<a name="line-137"></a>    <span class="c1">// ..</span>
<a name="line-138"></a>    <span class="c1">// If the lower 3 bits are 0 we right-shift 7x</span>
<a name="line-139"></a>    <span class="n">prod</span> <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="mi">15</span><span class="o">-</span><span class="p">(</span><span class="n">exp</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">));</span>
<a name="line-140"></a>
<a name="line-141"></a>    <span class="c1">// Now convert to decimal.</span>
<a name="line-142"></a>    <span class="kt">uint8_t</span> <span class="n">hadNonzeroDigit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// a flag</span>
<a name="line-143"></a>    <span class="kt">uint8_t</span> <span class="n">outputIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<a name="line-144"></a>    <span class="kt">int64_t</span> <span class="n">decimal</span> <span class="o">=</span> <span class="mi">100000000000000ull</span><span class="p">;</span>
<a name="line-145"></a>
<a name="line-146"></a>    <span class="k">do</span> <span class="p">{</span>
<a name="line-147"></a>        <span class="kt">char</span> <span class="n">digit</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
<a name="line-148"></a>        <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span><span class="c1">// find the first nonzero digit or any of the next digits.</span>
<a name="line-149"></a>            <span class="k">while</span> <span class="p">((</span><span class="n">prod</span> <span class="o">-=</span> <span class="n">decimal</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
<a name="line-150"></a>                <span class="n">digit</span><span class="o">++</span><span class="p">;</span>
<a name="line-151"></a>            <span class="c1">// Now we got too low. Fix it by adding again, once.</span>
<a name="line-152"></a>            <span class="c1">// it might appear more efficient to check before subtract, or</span>
<a name="line-153"></a>            <span class="c1">// to save and restore last nonnegative value - but in fact</span>
<a name="line-154"></a>            <span class="c1">// they take as long time and more space.</span>
<a name="line-155"></a>            <span class="n">prod</span> <span class="o">+=</span> <span class="n">decimal</span><span class="p">;</span>
<a name="line-156"></a>            <span class="n">decimal</span> <span class="o">/=</span> <span class="mi">10</span><span class="p">;</span>
<a name="line-157"></a>
<a name="line-158"></a>            <span class="c1">// If already found a leading nonzero digit, accept zeros.</span>
<a name="line-159"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">hadNonzeroDigit</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
<a name="line-160"></a>
<a name="line-161"></a>            <span class="c1">// Else, don&#39;t return results with a leading zero! Instead</span>
<a name="line-162"></a>            <span class="c1">// skip those and decrement exp10 accordingly.</span>
<a name="line-163"></a>            <span class="k">if</span><span class="p">(</span><span class="n">digit</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="p">{</span>
<a name="line-164"></a>                <span class="n">exp10</span><span class="o">--</span><span class="p">;</span>
<a name="line-165"></a>                <span class="k">continue</span><span class="p">;</span>
<a name="line-166"></a>            <span class="p">}</span>
<a name="line-167"></a>
<a name="line-168"></a>            <span class="n">hadNonzeroDigit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="line-169"></a>
<a name="line-170"></a>            <span class="c1">// Compute how many digits N to output.</span>
<a name="line-171"></a>            <span class="k">if</span><span class="p">(</span><span class="n">maxDecimals</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>                        <span class="c1">// If limiting decimals...</span>
<a name="line-172"></a>                <span class="kt">int8_t</span> <span class="n">beforeDP</span> <span class="o">=</span> <span class="n">exp10</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>                <span class="c1">// Digits before point</span>
<a name="line-173"></a>                <span class="k">if</span> <span class="p">(</span><span class="n">beforeDP</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="n">beforeDP</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>            <span class="c1">// Numbers &lt; 1 should also output at least 1 digit.</span>
<a name="line-174"></a>                <span class="cm">/*</span>
<a name="line-175"></a><span class="cm">                 * Below a simpler version of this:</span>
<a name="line-176"></a><span class="cm">                int8_t afterDP = outputNum - beforeDP;</span>
<a name="line-177"></a><span class="cm">                if (afterDP &gt; maxDecimals-1)</span>
<a name="line-178"></a><span class="cm">                    afterDP = maxDecimals-1;</span>
<a name="line-179"></a><span class="cm">                outputNum = beforeDP + afterDP;</span>
<a name="line-180"></a><span class="cm">                */</span>
<a name="line-181"></a>                <span class="n">maxDecimals</span> <span class="o">=</span> <span class="n">maxDecimals</span><span class="o">+</span><span class="n">beforeDP</span><span class="mi">-1</span><span class="p">;</span>
<a name="line-182"></a>                <span class="k">if</span> <span class="p">(</span><span class="n">precision</span> <span class="o">&gt;</span> <span class="n">maxDecimals</span><span class="p">)</span>
<a name="line-183"></a>                    <span class="n">precision</span> <span class="o">=</span> <span class="n">maxDecimals</span><span class="p">;</span>
<a name="line-184"></a>
<a name="line-185"></a>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a name="line-186"></a>                <span class="n">precision</span><span class="o">++</span><span class="p">;</span>                            <span class="c1">// Output one more digit than the param value.</span>
<a name="line-187"></a>            <span class="p">}</span>
<a name="line-188"></a>
<a name="line-189"></a>            <span class="k">break</span><span class="p">;</span>
<a name="line-190"></a>        <span class="p">}</span>
<a name="line-191"></a>
<a name="line-192"></a>        <span class="c1">// Now have a digit.</span>
<a name="line-193"></a>        <span class="n">outputIdx</span><span class="o">++</span><span class="p">;</span>
<a name="line-194"></a>        <span class="k">if</span><span class="p">(</span><span class="n">digit</span> <span class="o">&lt;</span> <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="c1">// normal case.</span>
<a name="line-195"></a>            <span class="n">buf</span><span class="p">[</span><span class="n">outputIdx</span><span class="p">]</span> <span class="o">=</span> <span class="n">digit</span><span class="p">;</span>
<a name="line-196"></a>        <span class="k">else</span> <span class="p">{</span>
<a name="line-197"></a>            <span class="c1">// Abnormal case, write 9s and bail.</span>
<a name="line-198"></a>            <span class="c1">// We might as well abuse hadNonzeroDigit as counter, it will not be used again.</span>
<a name="line-199"></a>            <span class="k">for</span><span class="p">(</span><span class="n">hadNonzeroDigit</span><span class="o">=</span><span class="n">outputIdx</span><span class="p">;</span> <span class="n">hadNonzeroDigit</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">;</span> <span class="n">hadNonzeroDigit</span><span class="o">--</span><span class="p">)</span>
<a name="line-200"></a>                <span class="n">buf</span><span class="p">[</span><span class="n">hadNonzeroDigit</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;9&#39;</span><span class="p">;</span>
<a name="line-201"></a>            <span class="k">goto</span> <span class="n">roundup</span><span class="p">;</span> <span class="c1">// this is ugly but it _is_ code derived from assembler :)</span>
<a name="line-202"></a>        <span class="p">}</span>
<a name="line-203"></a>    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">outputIdx</span><span class="o">&lt;</span><span class="n">precision</span><span class="p">);</span>
<a name="line-204"></a>
<a name="line-205"></a>    <span class="c1">// Rounding:</span>
<a name="line-206"></a>    <span class="n">decimal</span> <span class="o">*=</span> <span class="mi">10</span><span class="p">;</span>
<a name="line-207"></a>
<a name="line-208"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">prod</span> <span class="o">-</span> <span class="p">(</span><span class="n">decimal</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="line-209"></a>
<a name="line-210"></a>    <span class="nl">roundup</span><span class="p">:</span>
<a name="line-211"></a>        <span class="c1">// Increment digit, cascade</span>
<a name="line-212"></a>        <span class="k">while</span><span class="p">(</span><span class="n">outputIdx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<a name="line-213"></a>            <span class="k">if</span><span class="p">(</span><span class="o">++</span><span class="n">buf</span><span class="p">[</span><span class="n">outputIdx</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
<a name="line-214"></a>                <span class="k">if</span><span class="p">(</span><span class="n">outputIdx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<a name="line-215"></a>                    <span class="n">buf</span><span class="p">[</span><span class="n">outputIdx</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;1&#39;</span><span class="p">;</span>
<a name="line-216"></a>                    <span class="n">exp10</span><span class="o">++</span><span class="p">;</span>
<a name="line-217"></a>                    <span class="n">flags</span> <span class="o">|=</span> <span class="n">FTOA_CARRY</span><span class="p">;</span>
<a name="line-218"></a>                    <span class="k">break</span><span class="p">;</span>
<a name="line-219"></a>                <span class="p">}</span> <span class="k">else</span>
<a name="line-220"></a>                    <span class="n">buf</span><span class="p">[</span><span class="n">outputIdx</span><span class="o">--</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span> <span class="c1">// and the loop continues, carrying to next digit.</span>
<a name="line-221"></a>            <span class="p">}</span>
<a name="line-222"></a>            <span class="k">else</span> <span class="k">break</span><span class="p">;</span>
<a name="line-223"></a>        <span class="p">}</span>
<a name="line-224"></a>    <span class="p">}</span>
<a name="line-225"></a>
<a name="line-226"></a>    <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
<a name="line-227"></a>    <span class="k">return</span> <span class="n">exp10</span><span class="p">;</span>
<a name="line-228"></a><span class="p">}</span>
<a name="line-229"></a>
</pre></div>
</td></tr></table>
      </div> <!-- /.wrapper -->
    </div>
    <div id="footer" class="footer">
      <p>
        Cppcheck 2.3 - a tool for static C/C++ code analysis<br>
        <br>
        Internet: <a href="http://cppcheck.net">http://cppcheck.net</a><br>
        IRC: <a href="irc://irc.freenode.net/cppcheck">irc://irc.freenode.net/cppcheck</a><br>
      </p>
    </div>
  </body>
</html>
